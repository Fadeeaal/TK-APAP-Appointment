<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>Update Diagnosis & Treatments</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.1/dist/css/bootstrap.min.css" rel="stylesheet">

    <style>
        .treatment-item {
            display: flex;
            align-items: center;
            margin-bottom: 5px;
        }

        .treatment-item button {
            margin-left: 10px;
        }
    </style>
</head>
<body>
    <nav th:replace="~{fragments/navbar :: navbar}"></nav>
    <div class="container">
        <h1>Update Diagnosis & Treatments for Appointment ID: <span th:text="${appointment.id}"></span></h1>

        <form th:action="@{/appointment/note}" method="post" th:object="${appointment}">
            <input type="hidden" th:field="*{id}" />

            <!-- Diagnosis input -->
            <div class="mb-3">
                <label for="diagnosis" class="form-label">Diagnosis</label>
                <textarea class="form-control" id="diagnosis" th:field="*{diagnosis}" required></textarea>
            </div>

            <!-- Treatment selection -->
            <div class="form-group">
                <label for="treatment-select">Select Treatment</label>
                <select id="treatment-select" class="form-control">
                    <option th:each="treatment : ${treatmentList}" th:value="${treatment.id}" th:text="${treatment.name}"></option>
                </select>
                <button type="button" class="btn btn-success mt-2" id="add-treatment-btn">Add Treatment</button>
            </div>

            <!-- Selected treatments list -->
            <div class="form-group mt-3">
                <label for="selected-treatments">Selected Treatments</label>
                <ul id="selected-treatments"></ul>
            </div>

            <!-- Hidden input to send treatment IDs -->
            <input type="hidden" id="treatment-ids" name="treatmentIds" />

            <!-- Submit button -->
            <button type="submit" class="btn btn-primary mt-3">Save Diagnosis & Treatments</button>
        </form>

        <!-- Button kembali ke halaman semua appointments -->
        <a href="/appointment/all" class="btn btn-secondary mt-3">Kembali</a>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const treatmentSelect = document.getElementById('treatment-select');
            const selectedTreatmentsContainer = document.getElementById('selected-treatments');
            const treatmentIdsInput = document.getElementById('treatment-ids');
            let selectedTreatments = [];

            // Event listener untuk menambahkan treatment
            document.getElementById('add-treatment-btn').addEventListener('click', function() {
                const selectedTreatmentId = treatmentSelect.value;
                const selectedTreatmentText = treatmentSelect.options[treatmentSelect.selectedIndex].text;

                if (!selectedTreatments.includes(selectedTreatmentId)) {
                    selectedTreatments.push(selectedTreatmentId);

                    // Buat list item untuk treatment yang dipilih
                    const li = document.createElement('li');
                    li.classList.add('treatment-item');
                    li.innerHTML = `
                        ${selectedTreatmentText}
                        <button type="button" class="btn btn-danger btn-sm remove-btn" data-id="${selectedTreatmentId}">Remove</button>
                    `;
                    selectedTreatmentsContainer.appendChild(li);

                    // Update input hidden untuk menyimpan treatment IDs
                    treatmentIdsInput.value = selectedTreatments.join(',');

                    // Event listener untuk tombol remove
                    li.querySelector('.remove-btn').addEventListener('click', function() {
                        const treatmentId = this.getAttribute('data-id');
                        selectedTreatments = selectedTreatments.filter(id => id !== treatmentId);
                        treatmentIdsInput.value = selectedTreatments.join(',');
                        li.remove();
                    });
                }
            });
        });
    </script>
</body>
</html>
